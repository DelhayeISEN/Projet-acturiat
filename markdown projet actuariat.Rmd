---
title: "projet actuariat"
author: "Delhaye"
date: "19/03/2020"
output:
  html_document: default
  pdf_document: default
---

### Installation des packages utilisées dans ce projet 

```{r}
#install.packages(c("xts","sp","zoo"))
#install.packages("Hmisc")
#install.packages(c("FactoMineR", "factoextra"))
```


### Installation du package CASdatasets contenant les 2 jeux de données sur lesquels nous allons travaillés

```{r}
#install.packages("CASdatasets", repos = "http://dutangc.free.fr/pub/RRepos/", type="source")
```

### Importation des librairies nécessaires aux datasets

```{r, echo = FALSE}
library(zoo)
library(xts)
library(sp)
library(CASdatasets)
```

### Chargement des 2 jeux de données freMPL1 et freMPL2

```{r, echo = FALSE}
data(freMPL1)
data(freMPL2)
```

Un peu à la manière du machine learning, les données contenues dans freMPL2 serviront de données d'entraînement de notre modèle et les données de freMPL1 serviront pour tester notre modèle final.

# 1. Explorez les données freMPL1 et freMPL2 à l'aide des techniques exploratoires usuelles (statistiques descriptives, ACP, AFC)

### freMPL1

Dans un premier temps, regardons les premières lignes du jeu de données 
```{r}
head(freMPL1)
```
 et les dimmensions de notre jeu de données : 
```{r}
dim(freMPL1)
```
 Le jeu contient 48295 données différentes, toutes définies par 22 caractéristiques différentes. 

Affichons les différents noms des colonnes : 
```{r}
colnames(freMPL1)
```

Regardons maintenant les différents types d'objets figurant dans les colonnes :  
```{r}
str(freMPL1)
```
Nous avons donc des objets de type numeric, de type factor, de type int et même de type date. 

Regardons maintenant plus précisement les valeurs particulières de ces colonnes (valeurs minimum et maximum, moyenne, médiane,quantiles, ...)

```{r}
summary(freMPL1)
```

### Exploration du jeu de données d'entraînement : freMPL2

Dans un premier temps, regardons les premières lignes du jeu de données 
```{r}
head(freMPL2)
```
 et les dimmensions de notre jeu de données : 
```{r}
dim(freMPL2)
```
 Le jeu contient 48295 données différentes, toutes définies par 22 caractéristiques différentes. 

Affichons les différents noms des colonnes : 
```{r}
colnames(freMPL2)
```

###### Nettoyage de données

Remarquons qu'il serait intéressant de faire un peu de nettoyage de données avant d'effectuer quelconques travaux sur celles-ci.
Pour cela, nous allons créer une fonction qui servira à nettoyer les 2 dataframes.

```{r}
nettoyage_dataframe <- function(dataframe){
  
  # Suppression des données des individus assurés moins d'un jour (Exposure)
  dataframe <- subset(dataframe,dataframe$Exposure>1/365.25)
  
  # Modification des données des individus ayant un ClaimAmount négatif
  dataframe <- subset(dataframe,dataframe$ClaimAmount>=0)
  
  # Suppression de la colonne associée au sexe de la personne
  dataframe <- dataframe[,-6]
  
  # Réduction du nombre de catégories socioprofessionnels
  levels(dataframe$SocioCateg) <- c(levels(dataframe$SocioCateg), "CSP4", "CSP6","CSP9")
  for (i in 1:dim(dataframe)[1]){
    if (dataframe$SocioCateg[i]%in%c("CSP1","CSP16","CSP18","CSP19")){
      dataframe$SocioCateg[i]<-"CSP1"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP2", "CSP20", "CSP21", "CSP22", "CSP23", "CSP25", "CSP26", "CSP27", "CSP28")){
      dataframe$SocioCateg[i]<-"CSP2"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP3", "CSP30", "CSP31", "CSP32", "CSP33", "CSP35", "CSP36", "CSP37", "CSP38", "CSP39")){
      dataframe$SocioCateg[i]<-"CSP3"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP40", "CSP41", "CSP42", "CSP43", "CSP46", "CSP47", "CSP48", "CSP49")){
      dataframe$SocioCateg[i]<-"CSP4"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP5", "CSP50", "CSP51", "CSP55", "CSP56", "CSP57", "CSP59")){
      dataframe$SocioCateg[i]<-"CSP5"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP6", "CSP60", "CSP61", "CSP62", "CSP63", "CSP65", "CSP66")){
      dataframe$SocioCateg[i]<-"CSP6"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP7", "CSP70", "CSP73", "CSP74", "CSP77")){
      dataframe$SocioCateg[i]<-"CSP7"
      }
    if (dataframe$SocioCateg[i]%in%c("CSP9", "CSP91")){
      dataframe$SocioCateg[i]<-"CSP9"
      }
  }
  dataframe$SocioCateg <- droplevels(dataframe$SocioCateg)
  
  # Traduction des données (VehBody, MariStat, VehUsage, VehEngine, VehEnergy, Garage)
  for (i in 1:dim(dataframe)[2]){
    # Type de véhicules
    if (colnames(dataframe)[i]=="VehBody"){
      levels(dataframe$VehBody) <- c(levels(dataframe$VehBody), "autobus", "coupé",
                                     "autre microvan", "berline","SUV", "break",
                                     "camionnette")
      dataframe$VehBody[dataframe$VehBody == "bus"]<-"autobus"
      dataframe$VehBody[dataframe$VehBody == "coupe"]<-"coupé"
      dataframe$VehBody[dataframe$VehBody == "other microvan"]<-"autre microvan"
      dataframe$VehBody[dataframe$VehBody == "sedan"]<-"berline"
      dataframe$VehBody[dataframe$VehBody == "sport utility vehicle"]<-"SUV"
      dataframe$VehBody[dataframe$VehBody == "station wagon"]<-"break"
      dataframe$VehBody[dataframe$VehBody == "van"]<-"camionnette"
      dataframe$VehBody <- droplevels(dataframe$VehBody)
      }
    # Statut marital
    if (colnames(dataframe)[i]=="MariStat"){
      levels(dataframe$MariStat) <- c(levels(dataframe$MariStat), "célibataire", "autre")
      dataframe$MariStat[dataframe$MariStat == "Alone"]<-"célibataire"
      dataframe$MariStat[dataframe$MariStat == "Other"]<-"autre"
      dataframe$MariStat <- droplevels(dataframe$MariStat)
      }
    # Utilisation du véhicule
    if (colnames(dataframe)[i]=="VehUsage"){
      levels(dataframe$VehUsage) <- c(levels(dataframe$VehUsage), "privée", 
                                      "privée et trajet vers bureau", "professionnel", 
                                      "trajet professionnel" )
      dataframe$VehUsage[dataframe$VehUsage == "Private"]<-"privée"
      dataframe$VehUsage[dataframe$VehUsage == "Private+trip to office"]<-"privée et trajet vers bureau"
      dataframe$VehUsage[dataframe$VehUsage == "Professional"]<-"professionnel"
      dataframe$VehUsage[dataframe$VehUsage == "Professional run"]<-"trajet professionnel"
      dataframe$VehUsage <- droplevels(dataframe$VehUsage)
      }
    # Moteur du véhicule
    if (colnames(dataframe)[i]=="VehEngine"){
      levels(dataframe$VehEngine) <- c(levels(dataframe$VehEngine), "injection directe surpuissante",
                                       "électrique", "injection surpuissante")
      dataframe$VehEngine[dataframe$VehEngine == "direct injection overpowered"]<-"injection directe surpuissante"
      dataframe$VehEngine[dataframe$VehEngine == "electric"]<-"électrique"
      dataframe$VehEngine[dataframe$VehEngine == "injection overpowered"]<-"injection surpuissante"
      dataframe$VehEngine <- droplevels(dataframe$VehEngine)
      }
    # Energie utilisée par le véhicule
    if (colnames(dataframe)[i]=="VehEnergy"){
      levels(dataframe$VehEnergy) <- c(levels(dataframe$VehEnergy), "électrique", "essence")
      dataframe$VehEnergy[dataframe$VehEnergy == "regular"]<-"essence"
      dataframe$VehEnergy[dataframe$VehEnergy == "eletric"]<-"électrique"
      dataframe$VehEnergy <- droplevels(dataframe$VehEnergy)
      }
    # Garage
    if (colnames(dataframe)[i]=="Garage"){
      levels(dataframe$Garage) <- c(levels(dataframe$Garage), "aucun", "garage indépendant", "concessionnaire")
      dataframe$Garage[dataframe$Garage == "None"]<-"aucun"
      dataframe$Garage[dataframe$Garage == "Private garage"]<-"garage indépendant"
      dataframe$Garage[dataframe$Garage == "Collective garage"]<-"concessionnaire"
      dataframe$Garage <- droplevels(dataframe$Garage)
    }
  }
  return (dataframe)
}
```

Tests de la fonction sur nos 2 dataframes : 

```{r}
freMPL2 <- nettoyage_dataframe(freMPL2)
freMPL1 <- nettoyage_dataframe(freMPL1)
freMPL2
freMPL1
```

###### Statistiques descriptives 

Regardons maintenant les différents types d'objets figurant dans les colonnes :  
```{r}
str(freMPL2)
```
Nous avons donc des objets de type numeric, de type factor, de type int et même de type date. 

Regardons maintenant plus précisement les valeurs particulières de ces colonnes (valeurs minimum et maximum, moyenne, médiane,quantiles, ...)

```{r}
summary(freMPL2)
```
On remarquera qu'il existe des données manquantes dans la colonne RecEnd.

On peut aussi utiliser la méthode describe du package Hmisc pour avoir un aperçu de la dispersion des données.

```{r}
library("Hmisc")
describe(freMPL2)
```
Mais cela ne vaut pas une représentation graphique.

###### Représentations graphiques des données

###### Exposure : 

```{r}
par(fig=c(0.1,1,0.1,0.7), mar = c(0,0,2,2))
hist(freMPL2$Exposure,
      main = paste("Exposure"),
      ylab = "Effectifs",
      xlab = "Exposure in years ")
par(fig=c(0.1,1,0.8,1), mar = c(0,0,2,2), new = TRUE)
boxplot(freMPL2$Exposure, data = freMPL2, horizontal = TRUE)
```

###### LicAge : 

```{r}
par(fig=c(0.1,1,0.1,0.7), mar = c(0,0,2,2))
hist(freMPL2$LicAge,
      main = paste("LicAge"),
      ylab = "Effectifs",
      xlab = "Licence Age in months ",
     proba = TRUE)
lines(density(freMPL2$LicAge), col = "red", lwd=3)
par(fig=c(0.1,1,0.8,1), mar = c(0,0,2,2), new = TRUE)
boxplot(freMPL2$LicAge, data = freMPL2, horizontal = TRUE)
```
###### VehAge

```{r}
library("ggplot2")
library("dplyr") 
barplot(table(freMPL2$VehAge), main = "VehAge", names = c('0','1','2','3','4','5','6-7','8-9','10+'))

# Affichage diagramme camembert 

dtVehAge <- data.frame(
  class = c('0','1','2','3','4','5','6-7','8-9','10+'),
  n = as.data.frame(table(freMPL2$VehAge))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$VehAge)),2))[,2]
)
dtVehAge <- dtVehAge %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtVehAge, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### MariStat

```{r}
barplot(table(freMPL2$MariStat), main = "MariStat")

# Affichage diagramme camembert 

dtMariStat <- data.frame(
  class = levels(freMPL2$MariStat),
  n = as.data.frame(table(freMPL2$MariStat))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$MariStat)),2))[,2]
)
dtMariStat <- dtMariStat %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtMariStat, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### SocioCateg

```{r}
barplot(table(freMPL2$SocioCateg), main = "SocioCateg")

# Affichage diagramme camembert 

dtSocioCateg <- data.frame(
  class = levels(freMPL2$SocioCateg),
  n = as.data.frame(table(freMPL2$SocioCateg))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$SocioCateg)),2))[,2]
)
dtSocioCateg <- dtSocioCateg %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtSocioCateg, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### VehUsage

```{r}
barplot(table(freMPL2$VehUsage), main = "VehUsage")

# Affichage diagramme camembert 

dtVehUsage <- data.frame(
  class = levels(freMPL2$VehUsage),
  n = as.data.frame(table(freMPL2$VehUsage))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$VehUsage)),2))[,2]
)
dtVehUsage <- dtVehUsage %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtVehUsage, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### DrivAge

```{r}
par(fig=c(0.1,1,0.1,0.7), mar = c(0,0,2,2))
hist(freMPL2$DrivAge,
      main = paste("DrivAge"),
      ylab = "Effectifs",
      xlab = "The driver age, in years",
     proba = TRUE)
lines(density(freMPL2$DrivAge), col = "red", lwd=3)
par(fig=c(0.1,1,0.8,1), mar = c(0,0,2,2), new = TRUE)
boxplot(freMPL2$DrivAge, data = freMPL2, horizontal = TRUE)
```

###### HasKmLimit

```{r}
barplot(table(freMPL2$HasKmLimit), main = "HasKmLimit")

# Affichage diagramme camembert 

dtHasKmLimit <- data.frame(
  class = c("0","1"),
  n = as.data.frame(table(freMPL2$HasKmLimit))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$HasKmLimit)),2))[,2]
)
dtHasKmLimit <- dtHasKmLimit %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtHasKmLimit, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### BonusMalus

```{r}
par(fig=c(0.1,1,0.1,0.7), mar = c(0,0,2,2))
hist(freMPL2$BonusMalus,
      main = paste("BonusMalus"),
      ylab = "Effectifs",
      xlab = "A numeric for the bonus/malus")
par(fig=c(0.1,1,0.8,1), mar = c(0,0,2,2), new = TRUE)
boxplot(freMPL2$BonusMalus, data = freMPL2, horizontal = TRUE)
```

###### VehBody

```{r}
barplot(table(freMPL2$VehBody), main = "VehBody")

# Affichage diagramme camembert 

dtVehBody <- data.frame(
  class = levels(freMPL2$VehBody),
  n = as.data.frame(table(freMPL2$VehBody))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$VehBody)),2))[,2]
)
dtVehBody <- dtVehBody %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtVehBody, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### VehPrice

```{r, echo = FALSE}
barplot(table(freMPL2$VehPrice), main = "VehPrice")
dt <- as.data.frame(table(freMPL2$VehPrice))
lines(dt[,1],dt[,2],col = "red", lwd=3)
# Affichage diagramme camembert 

dtVehPrice <- data.frame(
  class = levels(freMPL2$VehPrice),
  n = as.data.frame(table(freMPL2$VehPrice))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$VehPrice)),2))[,2]
)
dtVehPrice <- dtVehPrice %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtVehPrice, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### VehEngine

```{r}
barplot(table(freMPL2$VehEngine), main = "VehEngine")
# Affichage diagramme camembert 

dtVehEngine <- data.frame(
  class = levels(freMPL2$VehEngine),
  n = as.data.frame(table(freMPL2$VehEngine))[,2],
  prop = as.data.frame(round(prop.table(table(freMPL2$VehEngine)),2))[,2]
)
dtVehEngine <- dtVehEngine %>%
  arrange(desc(class)) %>%
  mutate(lab.ypos = cumsum(prop) - 0.5*prop)
ggplot(dtVehEngine, aes(x = "", y = prop, fill = class)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  coord_polar("y", start = 0)+
  geom_text(aes(y = lab.ypos, label = prop), color = "white")+
  theme_void()
```

###### ACP 

L'ACP permet d’analyser et de visualiser un jeu de données contenant des individus décrits par plusieurs variables quantitatives.
C’est une méthode statistique qui permet d’explorer des données dites multivariées (données avec plusieurs variables). Chaque variable pourrait être considérée comme une dimension différente.
L’analyse en composantes principales est utilisée pour extraire et de visualiser les informations importantes contenues dans une table de données multivariées. L’ACP synthétise cette information en seulement quelques nouvelles variables appelées composantes principales. Ces nouvelles variables correspondent à une combinaison linéaire des variables originels. Le nombre de composantes principales est inférieur ou égal au nombre de variables d’origine.

###### Exécution sur nos données freMPL2

Attention, les valeurs doivent être numériques.

On va donc convertir nos valeurs en numérique :
```{r}
freMPL2$LicAge <- as.numeric(freMPL2$LicAge)
freMPL2$VehAge <- as.numeric(freMPL2$VehAge)
freMPL2$DrivAge <- as.numeric(freMPL2$DrivAge)
freMPL2$BonusMalus <- as.numeric(freMPL2$BonusMalus)
freMPL2$RiskVar <- as.numeric(freMPL2$RiskVar)
freMPL2$ClaimAmount <- as.numeric(freMPL2$ClaimAmount)
str(freMPL2)
model.matrix(~ freMPL2$VehBody)
```

```{r}
library("FactoMineR")
library("factoextra") # Pour la visualisation 
```

```{r}
freMPL2.active <- freMPL2[,c(1:2,5:10,12:21)]
freMPL2.pca <- PCA(freMPL2.active, graph = FALSE)
```

Affichage du résultat : 

```{r}
print(freMPL2.pca)
```

```{r}
get_eigenvalue(freMPL2.pca)
fviz_eig(freMPL2.pca)
```

utilisation de cos2 pour juger de la qualité de la représentation :

```{r}
fviz_pca_var(freMPL2.pca, col.var = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE # Évite le chevauchement de texte
             )
```

contribution des colonnes aux dimensions : 

```{r}
fviz_pca_var(freMPL2.pca, col.var = "contrib",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07")
             )
```
Description des dimensions

Dans les sections précédentes, nous avons décrit comment mettre en évidence les variables en fonction de leurs contributions aux composantes principales.

Notez également que la fonction dimdesc() [dans FactoMineR], pour dimension description (en anglais), peut être utilisée pour identifier les variables les plus significativement associées avec une composante principale donnée . Elle peut être utilisée comme suit:

```{r}
freMPL2.desc <- dimdesc(freMPL2.pca, axes = c(1,2), proba = 0.05)
freMPL2.desc
```

###### AFC 

L’ analyse factorielle des correspondances est une extension de l’analyse en composantes principales pour analyser l’association entre deux variables qualitatives (ou catégorielles).
L’AFC permet de résumer et de visualiser l’information contenue dans le tableau de contingence formé par les deux variables catégorielles. Le tableau de contingence contient les fréquences formées par les deux variables.

```{r}
library ("FactoMineR")
freMPL2.active <- freMPL2[,c(1:2,5:10,12:19,21)]
freMPL2.ca <- CA (freMPL2.active)
print(freMPL2.ca)
```
```{r}
get_eigenvalue(freMPL2.ca)
fviz_screeplot (freMPL2.ca, addlabels = TRUE)
```
```{r}
fviz_ca_col (freMPL2.ca, col.col = "cos2",
             gradient.cols = c("#00AFBB", "#E7B800", "#FC4E07"),
             repel = TRUE)
fviz_cos2 (freMPL2.ca, choice = "col", axes = 1:2)
```

```{r}
res.desc <- dimdesc(freMPL2.ca, axes = c(1, 2))
res.desc[[1]]$col
```


###### GLM 

```{r}
#calibration d’une loi de Poisson
fpois <- glm(RiskVar~DrivAge+VehAge+VehClass+VehBody+VehEnergy+Gender, offset=log(Exposure), family=poisson("log"), data=freMPL2)
summary(fpois)

#calibration d’une loi Poisson sur-dispersée
fpois2 <- glm(RiskVar~DrivAge+VehAge+VehClass+VehBody+VehEnergy+Gender, offset=log(Exposure), family=quasipoisson("log"), data=freMPL2)
summary(fpois2)
```



